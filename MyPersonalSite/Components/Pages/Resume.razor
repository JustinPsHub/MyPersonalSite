@page "/resume"
@using System.Net.Http.Json
@using System.Text.RegularExpressions
@using MyPersonalSite.Shared.DTOs
@using MyPersonalSite.Shared.Models
@inject IHttpClientFactory HttpFactory
@inject NavigationManager Nav
@inject IJSRuntime JS
@using MyPersonalSite.Components.Shared

<PageTitle>Resume • Justin — .NET / Blazor / Data</PageTitle>

<div class="resume-page">
    <!-- ===== HERO (same structure as About) ===== -->
    <section class="hero-section">
        <div class="container">
            <div class="hero-photo hero-gradient hero-tall about-hero">
                <picture class="hero-bg">
                    <img src="/img/hero-winter.png" alt="Winter scene hero" loading="eager" fetchpriority="high" />
                </picture>

                <div class="hero-scrim" aria-hidden="true"></div>

                <div class="container py-4 py-md-5">
                    <div class="row">
                        <div class="col-12 col-xl-9">
                            <div class="hero-copy">
                                <h1 class="hero-title mb-2">Resume</h1>
                                <p class="lead text-hero-body mb-0">
                                    .NET / Blazor engineer focused on secure, data-driven apps and enterprise BI.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <div class="hero-break"></div>

    <!-- ===== BODY ===== -->
    <section class="resume-container mx-auto px-2 px-md-0" itemscope itemtype="https://schema.org/Person">
        <!-- Header -->
        <header class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-2 mb-3 resume-header">
            <div>
                <h1 class="h3 mb-1" itemprop="name">Justin</h1>
                <div class="d-flex flex-wrap gap-2 mb-1">
                    <span class="chip" itemprop="jobTitle">.NET / Blazor Engineer</span>
                    <span class="chip">Data Engineering</span>
                    <span class="chip">EF Core • SQL</span>
                    <link itemprop="url" href="@Nav.BaseUri" />
                </div>
                <p class="mb-0 text-muted small">
                    Builds secure .NET apps, owns Power BI governance (incl. RLS), and automates data workflows with ADF, Azure Functions, and PowerShell.
                </p>
            </div>

            <div class="d-flex flex-column align-items-stretch align-items-md-end gap-2">
                <div class="d-flex gap-2">
                    <a class="btn btn-outline-primary btn-sm" href="/about" aria-label="About Justin">About</a>
                    <button class="btn btn-outline-secondary btn-sm d-print-none" @onclick="PrintAsync" aria-label="Print this resume or save as PDF">
                        Print / PDF
                    </button>
                    <a class="btn btn-outline-secondary btn-sm d-print-none" href="/api/resume" aria-label="Download resume data as JSON">
                        JSON
                    </a>
                </div>
                <div class="d-flex flex-wrap gap-2 small text-muted">
                    <span class="chip">Washington, DC</span>
                    <a class="chip" href="mailto:someone@example.com" rel="noopener">Email</a>
                    <a class="chip" href="https://www.linkedin.com/" target="_blank" rel="noopener">LinkedIn</a>
                </div>
            </div>
        </header>

        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <div class="alert alert-danger" role="alert">
                <strong>Failed to load resume:</strong> @_error
            </div>
        }
        else if (_sections is null)
        {
            <p>Loading…</p>
        }
        else
        {
            <!-- Highlights -->
            <section class="mb-3" id="highlights">
                <h2 class="sect">Highlights</h2>
                <div class="exp">
                    <ul class="exp-bullets">
                        <li>Lead engineer for Treasury’s shared analytics platform serving <strong>600+</strong> devs/analysts.</li>
                        <li>Migrated <strong>600+</strong> projects to Azure DevOps; standardized Repos/Boards/Wikis/Pipelines.</li>
                        <li>Admin for <strong>Power BI Service</strong> &amp; <strong>Report Server</strong> (upgrades, tuning, uptime).</li>
                        <li>Built production <strong>ADF</strong> ELT &amp; <strong>.NET Azure Functions</strong> for automation/integration.</li>
                        <li>Own enterprise <strong>RLS</strong> patterns and security tables; automate refresh/access.</li>
                    </ul>
                </div>
            </section>

            <!-- Skills -->
            <section class="mb-3" id="skills">
                <h2 class="sect">Skills</h2>
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="tile h-100">
                            <div class="tile-title mb-1">Languages &amp; Frameworks</div>
                            <div class="chips">
                                @Chip("C# / .NET 9") @Chip("ASP.NET (Server & WASM)")
                                @Chip("Razor/Blazor") @Chip("LINQ")
                                @Chip("JavaScript (interop)")
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="tile h-100">
                            <div class="tile-title mb-1">Data &amp; BI</div>
                            <div class="chips">
                                @Chip("SQL Server / SQLite") @Chip("EF Core") @Chip("SSIS")
                                @Chip("Power BI Service") @Chip("Power BI Report Server") @Chip("DAX")
                                @Chip("Dimensional Modeling")
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="tile h-100">
                            <div class="tile-title mb-1">Cloud &amp; DevOps</div>
                            <div class="chips">
                                @Chip("Azure") @Chip("Azure Data Factory") @Chip("Azure Function Apps")
                                @Chip("Azure DevOps (Repos/Boards/Wikis/Pipelines)") @Chip("CI/CD") @Chip("Git")
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="tile h-100">
                            <div class="tile-title mb-1">Automation &amp; APIs</div>
                            <div class="chips">
                                @Chip("PowerShell") @Chip("Power BI REST API")
                                @Chip("Microsoft Graph") @Chip("Azure Functions")
                                @Chip("Azure Data Factory (ELT)")
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Certifications -->
            <section class="mb-3" id="certs">
                <h2 class="sect">Certifications</h2>
                <div class="exp">
                    <div class="d-flex flex-wrap gap-2 mb-1">
                        <a class="chip" href="https://www.credly.com/badges/fd62d8eb-1d69-4b3b-9138-44c50c2e86ae" target="_blank" rel="noopener">Azure Fundamentals</a>
                        <a class="chip" href="https://www.credly.com/badges/fd62d8eb-1d69-4b3b-9138-44c50c2e86ae" target="_blank" rel="noopener">Azure Data Fundamentals</a>
                        <a class="chip" href="https://www.credly.com/badges/fd62d8eb-1d69-4b3b-9138-44c50c2e86ae" target="_blank" rel="noopener">Azure AI Fundamentals</a>
                    </div>
                    <div class="text-muted small">Credly profile linked.</div>
                </div>
            </section>

            <!-- DB-backed sections -->
            @if (_sections.Count == 0)
            {
                <div class="alert alert-info">No resume data available yet.</div>
            }
            else
            {
                @foreach (var s in _sections)
                {
                    // Experience newest first
                    IEnumerable<ResumeEntryDto> entries = s.Entries;
                    if (s.SectionTitle?.Contains("Experience", StringComparison.OrdinalIgnoreCase) == true)
                    {
                        entries = entries
                        .OrderByDescending(e => e.EndDate ?? DateTime.MaxValue)
                        .ThenByDescending(e => e.StartDate);
                    }

                    <section class="mb-4">
                        <h3 class="h5 border-bottom pb-2">@s.SectionTitle</h3>

                        @foreach (var e in entries)
                        {
                            var bullets = e.BulletPoints?.OrderBy(b => b.Order).Take(MaxBullets);

                            <article class="exp">
                                <div class="exp-head">
                                    <div>
                                        <div class="exp-title">@e.Title</div>
                                        @if (!string.IsNullOrWhiteSpace(e.Organization))
                                        {
                                            <div class="exp-sub">@e.Organization</div>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(e.Location))
                                        {
                                            <div class="text-muted small">@e.Location</div>
                                        }
                                    </div>
                                    <div class="text-nowrap">
                                        <span class="badge bg-primary-subtle text-primary">
                                            @FormatDateRange(e.StartDate, e.EndDate)
                                        </span>
                                    </div>
                                </div>

                                @if (!string.IsNullOrWhiteSpace(e.Description))
                                {
                                    <p class="mb-2 small text-muted">@Shorten(e.Description, 160)</p>
                                }

                                @if (bullets?.Any() == true)
                                {
                                    <ul class="exp-bullets">
                                        @foreach (var bp in bullets!)
                                        {
                                            <li>@bp.Text</li>
                                        }
                                    </ul>
                                }
                            </article>
                        }
                    </section>
                }
            }
        }
    </section>
</div>

@code {
    private List<ResumeSectionDto>? _sections;
    private string? _error;

    private const int MaxBullets = 4;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var http = HttpFactory.CreateClient();
            var uri = new Uri(new Uri(Nav.BaseUri), "api/resume");
            _sections = await http.GetFromJsonAsync<List<ResumeSectionDto>>(uri);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private RenderFragment Chip(string text) => __builder =>
    {
        __builder.OpenElement(0, "span");
        __builder.AddAttribute(1, "class", "chip");
        __builder.AddContent(2, text);
        __builder.CloseElement();
    };

    private static string Shorten(string text, int max)
    {
        var t = Regex.Replace(text ?? string.Empty, "\\s+", " ").Trim();
        if (t.Length <= max) return t;
        return t.Substring(0, Math.Max(0, max)).TrimEnd() + "…";
    }

    private static string FormatDateRange(DateTime start, DateTime? end)
    {
        var to = (end ?? DateTime.Today);
        if (to < start) to = start;

        var monthDiff = (to.Year - start.Year) * 12 + (to.Month - start.Month) - (to.Day < start.Day ? 1 : 0);
        var years = Math.Max(0, monthDiff / 12);
        var months = Math.Max(0, monthDiff % 12);

        string tenure;
        if (years == 0 && months == 0)
        {
            var days = (to - start).Days;
            tenure = $"{days} day{(days == 1 ? "" : "s")}";
        }
        else
        {
            var parts = new List<string>();
            if (years > 0) parts.Add($"{years} yr{(years > 1 ? "s" : "")}");
            if (months > 0) parts.Add($"{months} mo{(months > 1 ? "s" : "")}");
            tenure = string.Join(" ", parts);
        }

        var startStr = start.ToString("MMM yyyy");
        var endStr = end.HasValue ? end.Value.ToString("MMM yyyy") : "Present";
        return $"{startStr} — {endStr} • {tenure}";
    }

    private async Task PrintAsync()
    {
        try { await JS.InvokeVoidAsync("print"); } catch { }
    }
}
