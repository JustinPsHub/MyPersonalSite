@rendermode InteractiveServer
@page "/resume"
@using System.Net.Http.Json
@using System.Text.RegularExpressions
@using MyPersonalSite.Shared.DTOs
@using MyPersonalSite.Shared.Models
@inject IHttpClientFactory HttpFactory
@inject NavigationManager Nav
@inject IJSRuntime JS
@using MyPersonalSite.Components.Shared

<PageTitle>Resume - Justin Palmer - Senior Data Engineer & Cloud Architect</PageTitle>

<!-- Quiet heading for a11y -->
<div class="container-fluid pt-3">
    <h1 class="visually-hidden">Resume</h1>
    <meta itemprop="name" content="Justin Palmer" />
    <meta itemprop="email" content="justinraypalmer@gmail.com" />
</div>

<section class="container resume-container">
    <div class="resume-inner">
        <!-- HEADER -->
        <header class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-2 mb-3 resume-header">
            <div>
                <h2 class="h3 mb-1" itemprop="name">Justin Palmer</h2>
                <div class="d-flex flex-wrap gap-2 mb-1">
                    <span class="chip" itemprop="jobTitle">Senior Data Engineer &amp; Cloud Architect</span>
                    <span class="chip">Azure OpenAI / RAG</span>
                    <span class="chip">Tabular Models / Power BI</span>
                    <link itemprop="url" href="@Nav.BaseUri" />
                </div>
                <p class="mb-0 text-muted small">
                    Senior Data Engineer &amp; Cloud Architect with 16+ years delivering enterprise Azure data platforms,
                    governed analytics, and GenAI experiences with Blazor/React, .NET APIs, Azure Data Factory, and secure models.
                </p>
            </div>

            <div class="d-flex flex-column align-items-stretch align-items-md-end gap-2">
                <div class="d-flex gap-2 align-items-center">
                    <details class="export-dd d-print-none">
                        <summary class="btn btn-outline-secondary btn-sm" aria-label="Export options">Export v</summary>
                        <div class="menu">
                            <button class="dropdown-item" @onclick="PrintFullAsync" data-close>Print from page (full)</button>
@*                             <button class="dropdown-item" @onclick="PrintShortAsync" data-close>Print from page (1-page)</button>
 *@                        </div>
                    </details>
                </div>

                <div class="d-flex flex-wrap gap-2 small text-muted">
                    <span class="chip">Hillsboro, Ohio</span>
                    <a class="chip" href="mailto:justinraypalmer@gmail.com" rel="noopener">justinraypalmer@gmail.com</a>
                    <span class="chip">[redacted]</span>
                    <a class="chip" href="https://justinpalmer.com" target="_blank" rel="noopener">justinpalmer.com</a>
                </div>
            </div>
        </header>

        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <div class="alert alert-danger" role="alert">
                <strong>Failed to load resume:</strong> @_error
            </div>
        }
        else if (_sections is null)
        {
            <p>Loading...</p>
        }
        else
        {
            <!-- ===================== 1-PAGE SUMMARY (Karl-inspired) ===================== -->
            <!-- Hidden on page; used by print/export -->
            <section id="resume-summary" class="d-none" itemscope itemtype="https://schema.org/Person">
                <header class="rs-header">
                    <div class="rs-nameblock">
                        <h1 class="rs-name">Justin Palmer</h1>
                        <div class="rs-role">Senior Data Engineer &amp; Cloud Architect</div>
                        <p class="rs-tag">
                            16+ years delivering Azure OpenAI RAG, enterprise tabular models, Azure Data Factory pipelines,
                            Power BI governance, and Blazor/React + .NET APIs.
                        </p>
                    </div>
                    <div class="rs-contact">
                        Hillsboro, OH - <a href="mailto:justinraypalmer@gmail.com">justinraypalmer@gmail.com</a> - [redacted] - justinpalmer.com
                    </div>
                </header>

                <div class="rs-grid">
                    <!-- LEFT RAIL -->
                    <aside class="rs-left">
                        <section class="rs-block">
                            <h3 class="rs-label">Skills</h3>
                            <ul class="rs-list">
                                <li><strong>Big Data &amp; Cloud:</strong> Azure Data Factory, Functions, Azure SQL, Data Lake</li>
                                <li><strong>GenAI &amp; LLM:</strong> Azure OpenAI, RAG, prompt engineering, AI-augmented dev (Windsurf, Codex, Claude)</li>
                                <li><strong>Analytics &amp; Modeling:</strong> Tabular models, Power BI, DAX, star schema</li>
                                <li><strong>App &amp; API:</strong> React, Blazor, ASP.NET Core Web API, C#, Python</li>
                                <li><strong>Governance &amp; DevOps:</strong> RLS, vulnerability scanning, Azure DevOps CI/CD</li>
                            </ul>
                        </section>

                        <section class="rs-block">
                            <h3 class="rs-label">Certifications</h3>
                            <ul class="rs-list">
                                <li>Microsoft Azure AI Fundamentals (AI-900)</li>
                                <li>Microsoft Azure Data Fundamentals (DP-900)</li>
                                <li>Microsoft Azure Fundamentals (AZ-900)</li>
                            </ul>
                        </section>

                        <section class="rs-block">
                            <h3 class="rs-label">Education</h3>
                            @foreach (var ed in GetEducation(1))
                            {
                                <div class="rs-edu">
                                    <div class="rs-edu-title">@ed.Title</div>
                                    @if (!string.IsNullOrWhiteSpace(ed.Organization))
                                    {
                                        <div class="rs-edu-org">@ed.Organization</div>
                                    }
                                    <div class="rs-edu-dates">@FormatDateRange(ed.StartDate, ed.EndDate)</div>
                                </div>
                            }
                        </section>
                    </aside>

                    <!-- RIGHT MAIN -->
                    <main class="rs-right">
                        <section class="rs-block">
                            <h3 class="rs-label">Experience</h3>

                            @foreach (var ex in GetExperience(3))
                            {
                                <div class="rs-job">
                                    <div class="rs-job-head">
                                        <div>
                                            <div class="rs-job-title">@ex.Title</div>
                                            @if (!string.IsNullOrWhiteSpace(ex.Organization))
                                            {
                                                <div class="rs-job-org">@ex.Organization</div>
                                            }
                                        </div>
                                        <div class="rs-job-dates">@FormatDateRange(ex.StartDate, ex.EndDate)</div>
                                    </div>

                                    @if (!string.IsNullOrWhiteSpace(ex.Description))
                                    {
                                        <div class="rs-job-desc">@ex.Description</div>
                                    }

                                    @if (TakeBullets(ex, 3).Any())
                                    {
                                        <ul class="rs-bullets">
                                            @foreach (var p in TakeBullets(ex, 3))
                                            {
                                                <li>@p</li>
                                            }
                                        </ul>
                                    }
                                </div>
                            }
                        </section>

                        <section class="rs-block">
                            <h3 class="rs-label">Selected Projects</h3>
                            <ul class="rs-bullets">
                                <li>Azure OpenAI <strong>RAG</strong> observability agent for Power BI audit logs.</li>
                                <li>Human Capital <strong>Tabular Model</strong> with 25 fact tables and 90 dimensions.</li>
                                <li>Azure <strong>ADF</strong> pipelines and <strong>Functions</strong> for automated ingestion and alerting.</li>
                                <li>Blazor governance hub and React org chart app with secure .NET APIs.</li>
                            </ul>
                        </section>
                    </main>
                </div>
            </section>
            <!-- =================== /1-PAGE SUMMARY =================== -->
            <!-- ===== TOP-OF-PAGE: Highlights -> Experience -> Education ===== -->
            <section class="mb-3" id="highlights">
                <h2 class="sect">Highlights</h2>
                <div class="exp">
                    <ul class="exp-bullets">
                        <li>Architected Azure OpenAI <strong>RAG</strong> agent indexing millions of Power BI audit log events.</li>
                        <li>Built a Human Capital <strong>Tabular Model</strong> with 25 fact tables and 90 dimensions.</li>
                        <li>Led Python environment governance with vulnerability scanning and CCB approvals.</li>
                        <li>Delivered a React org chart app with .NET APIs and Azure SQL for real-time hierarchy data.</li>
                        <li>Built production <strong>ADF</strong> pipelines and Azure Functions for automated ingestion and alerting.</li>
                        <li>Migrated <strong>600+</strong> projects to Azure DevOps with reusable CI/CD templates.</li>
                    </ul>
                </div>
            </section>

            <section class="mb-3" id="experience">
                <h2 class="sect">Experience</h2>

                @foreach (var e in GetExperienceAll())
                {
                    var bullets = e.BulletPoints?.OrderBy(b => b.Order).Take(MaxBullets);
                    <article class="exp">
                        <div class="exp-head">
                            <div>
                                <div class="exp-title">@e.Title</div>
                                @if (!string.IsNullOrWhiteSpace(e.Organization))
                                {
                                    <div class="exp-sub">@e.Organization</div>
                                }
                                @if (!string.IsNullOrWhiteSpace(e.Location))
                                {
                                    <div class="text-muted small">@e.Location</div>
                                }
                            </div>
                            <div class="text-nowrap">
                                <span class="badge bg-primary-subtle text-primary">
                                    @FormatDateRange(e.StartDate, e.EndDate)
                                </span>
                            </div>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(e.Description))
                        {
                            <p class="mb-2 small text-muted">@e.Description</p>
                        }

                        @if (bullets?.Any() == true)
                        {
                            <ul class="exp-bullets">
                                @foreach (var bp in bullets!)
                                {
                                    <li>@bp.Text</li>
                                }
                            </ul>
                        }
                    </article>
                }
            </section>

            <section class="mb-3" id="education">
                <h2 class="sect">Education</h2>

                @foreach (var ed in GetEducationAll())
                {
                    <article class="exp">
                        <div class="exp-head">
                            <div>
                                <div class="exp-title">@ed.Title</div>
                                @if (!string.IsNullOrWhiteSpace(ed.Organization))
                                {
                                    <div class="exp-sub">@ed.Organization</div>
                                }
                                @if (!string.IsNullOrWhiteSpace(ed.Location))
                                {
                                    <div class="text-muted small">@ed.Location</div>
                                }
                            </div>
                            <div class="text-nowrap">
                                <span class="badge bg-primary-subtle text-primary">
                                    @FormatDateRange(ed.StartDate, ed.EndDate)
                                </span>
                            </div>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(ed.Description))
                        {
                            <p class="mb-2 small text-muted">@ed.Description</p>
                        }
                    </article>
                }
            </section>

            <!-- ===== BELOW THE FOLD: Skills, Certifications, Other DB-backed sections ===== -->
            <section class="mb-3" id="skills">
                <h2 class="sect">Skills</h2>
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="tile h-100">
                            <div class="tile-title mb-1">Big Data &amp; Cloud</div>
                            <div class="chips">
                                @Chip("Azure Data Factory") @Chip("Azure Functions")
                                @Chip("Azure SQL") @Chip("Blob Storage")
                                @Chip("Data Lake") @Chip("Event-driven pipelines")
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="tile h-100">
                            <div class="tile-title mb-1">Generative AI &amp; LLM Engineering</div>
                            <div class="chips">
                                @Chip("Azure OpenAI Service") @Chip("RAG")
                                @Chip("Prompt engineering") @Chip("AI-augmented development")
                                @Chip("Windsurf") @Chip("Codex") @Chip("Claude")
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="tile h-100">
                            <div class="tile-title mb-1">Analytics &amp; Modeling</div>
                            <div class="chips">
                                @Chip("Tabular Models / Cubes") @Chip("Power BI")
                                @Chip("DAX") @Chip("SSAS")
                                @Chip("Incremental Refresh") @Chip("Star Schema Design")
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="tile h-100">
                            <div class="tile-title mb-1">Application &amp; API</div>
                            <div class="chips">
                                @Chip("React") @Chip("Blazor")
                                @Chip("ASP.NET Core Web API") @Chip("C#")
                                @Chip("Python") @Chip("RESTful Services")
                                @Chip("OAuth/OpenID Connect")
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="tile h-100">
                            <div class="tile-title mb-1">Governance &amp; DevOps</div>
                            <div class="chips">
                                @Chip("RLS") @Chip("Vulnerability scanning")
                                @Chip("Conda/Venv management") @Chip("Azure DevOps CI/CD")
                                @Chip("Metadata governance")
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="mb-3" id="certs">
                <h2 class="sect">Certifications</h2>
                <div class="exp">
                    <div class="d-flex flex-wrap gap-2 mb-1">
                        <a class="chip" href="https://www.credly.com/badges/fd62d8eb-1d69-4b3b-9138-44c50c2e86ae/public_url" target="_blank" rel="noopener">Microsoft Azure AI Fundamentals (AI-900)</a>
                        <a class="chip" href="https://www.credly.com/badges/c430137f-c648-4e46-980e-c2670fa734d6/public_url" target="_blank" rel="noopener">Microsoft Azure Data Fundamentals (DP-900)</a>
                        <a class="chip" href="https://www.credly.com/badges/15b0a37b-949e-4524-8712-8c69ab4030d8/public_url" target="_blank" rel="noopener">Microsoft Azure Fundamentals (AZ-900)</a>
                    </div>
                    <div class="text-muted small">Credly profile linked.</div>
                </div>
            </section>

            @if (_sections.Count == 0)
            {
                <div class="alert alert-info">No resume data available yet.</div>
            }
            else
            {
                @foreach (var s in GetOtherSections())
                {
                    IEnumerable<ResumeEntryDto> entries = s.Entries;
                    if (s.SectionTitle?.Contains("Experience", StringComparison.OrdinalIgnoreCase) == true)
                    {
                        entries = entries
                        .OrderByDescending(e => e.EndDate ?? DateTime.MaxValue)
                        .ThenByDescending(e => e.StartDate);
                    }

                    <section class="mb-4">
                        <h3 class="h5 border-bottom pb-2">@s.SectionTitle</h3>

                        @foreach (var e in entries)
                        {
                            var bullets = e.BulletPoints?.OrderBy(b => b.Order).Take(MaxBullets);

                            <article class="exp">
                                <div class="exp-head">
                                    <div>
                                        <div class="exp-title">@e.Title</div>
                                        @if (!string.IsNullOrWhiteSpace(e.Organization))
                                        {
                                            <div class="exp-sub">@e.Organization</div>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(e.Location))
                                        {
                                            <div class="text-muted small">@e.Location</div>
                                        }
                                    </div>
                                    <div class="text-nowrap">
                                        <span class="badge bg-primary-subtle text-primary">
                                            @FormatDateRange(e.StartDate, e.EndDate)
                                        </span>
                                    </div>
                                </div>

                                @if (!string.IsNullOrWhiteSpace(e.Description))
                                {
                                    <p class="mb-2 small text-muted">@Shorten(e.Description, 160)</p>
                                }

                                @if (bullets?.Any() == true)
                                {
                                    <ul class="exp-bullets">
                                        @foreach (var bp in bullets!)
                                        {
                                            <li>@bp.Text</li>
                                        }
                                    </ul>
                                }
                            </article>
                        }
                    </section>
                }
            }
        }
    </div>
</section>

@code {
    private List<ResumeSectionDto>? _sections;
    private string? _error;
    private const int MaxBullets = 4;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var http = HttpFactory.CreateClient();
            var uri = new Uri(new Uri(Nav.BaseUri), "api/resume");
            _sections = await http.GetFromJsonAsync<List<ResumeSectionDto>>(uri);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private RenderFragment Chip(string text) => __builder =>
    {
        __builder.OpenElement(0, "span");
        __builder.AddAttribute(1, "class", "chip");
        __builder.AddContent(2, text);
        __builder.CloseElement();
    };

    private static string Shorten(string text, int max)
    {
        var t = Regex.Replace(text ?? string.Empty, "\\s+", " ").Trim();
        if (t.Length <= max) return t;
        return t.Substring(0, Math.Max(0, max)).TrimEnd() + "...";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Position the export menu next to the button,
            // and wire up outside-click / Esc to close.
            await JS.InvokeVoidAsync("resume.initExportDropdowns");
        }
    }

    private static string FormatDateRange(DateTime start, DateTime? end)
    {
        var to = (end ?? DateTime.Today);
        if (to < start) to = start;

        var monthDiff = (to.Year - start.Year) * 12 + (to.Month - start.Month) - (to.Day < start.Day ? 1 : 0);
        var years = Math.Max(0, monthDiff / 12);
        var months = Math.Max(0, monthDiff % 12);

        string tenure;
        if (years == 0 && months == 0)
        {
            var days = (to - start).Days;
            tenure = $"{days} day{(days == 1 ? "" : "s")}";
        }
        else
        {
            var parts = new List<string>();
            if (years > 0) parts.Add($"{years} yr{(years > 1 ? "s" : "")}");
            if (months > 0) parts.Add($"{months} mo{(months > 1 ? "s" : "")}");
            tenure = string.Join(" ", parts);
        }

        var startStr = start.ToString("MMM yyyy");
        var endStr = end.HasValue ? end.Value.ToString("MMM yyyy") : "Present";
        return $"{startStr} - {endStr} | {tenure}";
    }

    // ===== Robust helpers for 1-pager and ordering =====
    private static readonly string[] ExpKeys = new[] { "Experience", "Employment", "Work History", "Professional Experience" };
    private static readonly string[] EduKeys = new[] { "Education", "Academic" };

    private IEnumerable<ResumeEntryDto> GetExperienceAll()
    {
        var secs = _sections?
            .Where(s => !string.IsNullOrWhiteSpace(s.SectionTitle) &&
                        ExpKeys.Any(k => s.SectionTitle!.Contains(k, StringComparison.OrdinalIgnoreCase)))
            ?? Enumerable.Empty<ResumeSectionDto>();

        return secs.SelectMany(s => s.Entries)
                   .OrderByDescending(e => e.EndDate ?? DateTime.MaxValue)
                   .ThenByDescending(e => e.StartDate);
    }


    private IEnumerable<ResumeEntryDto> GetExperience(int take = 2)
        => GetExperienceAll().Take(take);

    private IEnumerable<ResumeEntryDto> GetEducationAll()
    {
        var secs = _sections?
            .Where(s => !string.IsNullOrWhiteSpace(s.SectionTitle) &&
                        EduKeys.Any(k => s.SectionTitle!.Contains(k, StringComparison.OrdinalIgnoreCase)))
            ?? Enumerable.Empty<ResumeSectionDto>();

        return secs.SelectMany(s => s.Entries)
                   .OrderByDescending(e => e.EndDate ?? DateTime.MaxValue)
                   .ThenByDescending(e => e.StartDate);
    }

    private IEnumerable<ResumeEntryDto> GetEducation(int take = 1)
        => GetEducationAll().Take(take);

    // Sections other than Experience/Education (shown after the top blocks)
    private IEnumerable<ResumeSectionDto> GetOtherSections()
    {
        if (_sections is null) return Enumerable.Empty<ResumeSectionDto>();
        return _sections
            .Where(s =>
                !string.IsNullOrWhiteSpace(s.SectionTitle) &&
                !ExpKeys.Any(k => s.SectionTitle!.Contains(k, StringComparison.OrdinalIgnoreCase)) &&
                !EduKeys.Any(k => s.SectionTitle!.Contains(k, StringComparison.OrdinalIgnoreCase))
            );
    }

    private static IEnumerable<string> TakeBullets(ResumeEntryDto e, int count)
        => e.BulletPoints?.OrderBy(b => b.Order).Select(b => b.Text).Take(count)
           ?? Enumerable.Empty<string>();

    // === Print fallbacks (optional) ===
    private Task PrintFullAsync()
        => JS.InvokeVoidAsync("resume.printResume", ".resume-container").AsTask();

    private Task PrintShortAsync()
        => JS.InvokeVoidAsync("resume.printResume", "#resume-summary").AsTask();
}
