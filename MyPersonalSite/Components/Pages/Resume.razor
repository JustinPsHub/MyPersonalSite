@rendermode InteractiveServer
@page "/resume"
@using System.Net.Http.Json
@using System.Text.RegularExpressions
@using MyPersonalSite.Shared.DTOs
@using MyPersonalSite.Shared.Models
@inject IHttpClientFactory HttpFactory
@inject NavigationManager Nav
@inject IJSRuntime JS
@using MyPersonalSite.Components.Shared

<PageTitle>Resume - Justin Palmer - Cloud and Data Developer</PageTitle>

<!-- Quiet heading for a11y -->
<div class="container-fluid pt-3">
    <h1 class="visually-hidden">Resume</h1>
    <meta itemprop="name" content="Justin Palmer" />
    <meta itemprop="email" content="justinraypalmer@gmail.com" />
</div>

<section class="container resume-container">
    <div class="resume-inner">
        <!-- HEADER -->
        <header class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-2 mb-3 resume-header">
            <div>
                <h2 class="h3 mb-1" itemprop="name">Justin Palmer</h2>
                <div class="d-flex flex-wrap gap-2 mb-1">
                    <span class="chip" itemprop="jobTitle">Cloud and Data Developer</span>
                    <span class="chip">Blazor / MVC / React</span>
                    <span class="chip">Azure SQL / Synapse SQL pool</span>
                    <link itemprop="url" href="@Nav.BaseUri" />
                </div>
                <p class="mb-0 text-muted small">
                    Builds secure .NET apps and APIs with Azure SQL and Synapse; delivers Blazor, MVC, and React front ends;
                    integrates analytics with Power BI (governed RLS, refresh, and access automation).
                </p>
            </div>

            <div class="d-flex flex-column align-items-stretch align-items-md-end gap-2">
                <div class="d-flex gap-2 align-items-center">
                    <details class="export-dd d-print-none">
                        <summary class="btn btn-outline-secondary btn-sm" aria-label="Export options">Export v</summary>
                        <div class="menu">
                            <!-- PDFs: static files you exported from Word -->
                            <a class="dropdown-item"
                               href="/resume/Justin_Palmer_Resume_Full.pdf"
                               download
                               target="_blank"
                               rel="noopener"
                               data-close>
                                PDF (full)
                            </a>

                            <!-- Word: static files -->
                            <a class="dropdown-item"
                               href="/resume/Justin_Palmer_Resume_Full.doc"
                               download
                               target="_blank"
                               rel="noopener"
                               data-close>
                                Word (full)
                            </a>

                            <div class="dropdown-divider"></div>

                            <a class="dropdown-item"
                               href="/resume/Justin_Palmer_Resume_OnePage_Tighter.pdf"
                               download
                               target="_blank"
                               rel="noopener"
                               data-close>
                                PDF (1-page)
                            </a>

                            <a class="dropdown-item"
                               href="/resume/Justin_Palmer_Resume_OnePage_Tighter.docx"
                               download
                               target="_blank"
                               rel="noopener"
                               data-close>
                                Word (1-page)
                            </a>

                            <!-- Optional: keep HTML print fallbacks -->
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item" @onclick="PrintFullAsync" data-close>Print from page (full)</button>
@*                             <button class="dropdown-item" @onclick="PrintShortAsync" data-close>Print from page (1-page)</button>
 *@                        </div>
                    </details>
                </div>

                <div class="d-flex flex-wrap gap-2 small text-muted">
                    <span class="chip">Hillsboro, Ohio</span>
                    <a class="chip" href="mailto:justinraypalmer@gmail.com" rel="noopener">justinraypalmer@gmail.com</a>
                </div>
            </div>
        </header>

        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <div class="alert alert-danger" role="alert">
                <strong>Failed to load resume:</strong> @_error
            </div>
        }
        else if (_sections is null)
        {
            <p>Loading...</p>
        }
        else
        {
            <!-- ===================== 1-PAGE SUMMARY (Karl-inspired) ===================== -->
            <!-- Hidden on page; used by print/export -->
            <section id="resume-summary" class="d-none" itemscope itemtype="https://schema.org/Person">
                <header class="rs-header">
                    <div class="rs-nameblock">
                        <h1 class="rs-name">Justin Palmer</h1>
                        <div class="rs-role">Cloud and Data Developer</div>
                        <p class="rs-tag">
                            Secure .NET delivery; Blazor/MVC/React; Azure SQL and Synapse SQL pool; Power BI governance; Azure Functions and ADF ELT.
                        </p>
                    </div>
                    <div class="rs-contact">
                        Hillsboro, OH - <a href="mailto:justinraypalmer@gmail.com">justinraypalmer@gmail.com</a> - <span>@Nav.BaseUri</span>
                    </div>
                </header>

                <div class="rs-grid">
                    <!-- LEFT RAIL -->
                    <aside class="rs-left">
                        <section class="rs-block">
                            <h3 class="rs-label">Skills</h3>
                            <ul class="rs-list">
                                <li><strong>.NET:</strong> C#, ASP.NET Core, APIs, LINQ</li>
                                <li><strong>Front end:</strong> Blazor, MVC, React, Razor</li>
                                <li><strong>Data/BI:</strong> Azure SQL, Synapse SQL pool, EF Core, Power BI (Service/RS, RLS)</li>
                                <li><strong>Cloud/DevOps:</strong> Azure, Azure DevOps, CI/CD, Git</li>
                                <li><strong>Automation:</strong> Azure Functions, ADF, PowerShell, Graph</li>
                                <li><strong>Security:</strong> CSP/headers, validation, antiforgery</li>
                            </ul>
                        </section>

                        <section class="rs-block">
                            <h3 class="rs-label">Certifications</h3>
                            <ul class="rs-list">
                                <li><strong>.NET:</strong> C#, ASP.NET Core, APIs, LINQ</li>
                                <li><strong>Front end:</strong> Blazor, MVC, React, Razor</li>
                                <li><strong>Data/BI:</strong> Azure SQL, Synapse SQL pool, EF Core, Power BI (Service/RS, RLS)</li>
                                <li><strong>Cloud/DevOps:</strong> Azure, Azure DevOps, CI/CD, Git</li>
                                <li><strong>Automation:</strong> Azure Functions, ADF, PowerShell, Graph</li>
                                <li><strong>Security:</strong> CSP/headers, validation, antiforgery</li>
                            </ul>
                        </section>

                        <section class="rs-block">
                            <h3 class="rs-label">Education</h3>
                            @foreach (var ed in GetEducation(1))
                            {
                                <div class="rs-edu">
                                    <div class="rs-edu-title">@ed.Title</div>
                                    @if (!string.IsNullOrWhiteSpace(ed.Organization))
                                    {
                                        <div class="rs-edu-org">@ed.Organization</div>
                                    }
                                    <div class="rs-edu-dates">@FormatDateRange(ed.StartDate, ed.EndDate)</div>
                                </div>
                            }
                        </section>
                    </aside>

                    <!-- RIGHT MAIN -->
                    <main class="rs-right">
                        <section class="rs-block">
                            <h3 class="rs-label">Experience</h3>

                            @foreach (var ex in GetExperience(3))
                            {
                                <div class="rs-job">
                                    <div class="rs-job-head">
                                        <div>
                                            <div class="rs-job-title">@ex.Title</div>
                                            @if (!string.IsNullOrWhiteSpace(ex.Organization))
                                            {
                                                <div class="rs-job-org">@ex.Organization</div>
                                            }
                                        </div>
                                        <div class="rs-job-dates">@FormatDateRange(ex.StartDate, ex.EndDate)</div>
                                    </div>

                                    @if (!string.IsNullOrWhiteSpace(ex.Description))
                                    {
                                        <div class="rs-job-desc">@ex.Description</div>
                                    }

                                    @if (TakeBullets(ex, 3).Any())
                                    {
                                        <ul class="rs-bullets">
                                            @foreach (var p in TakeBullets(ex, 3))
                                            {
                                                <li>@p</li>
                                            }
                                        </ul>
                                    }
                                </div>
                            }
                        </section>

                        <section class="rs-block">
                            <h3 class="rs-label">Selected Projects</h3>
                            <ul class="rs-bullets">
                                <li>.NET <strong>APIs</strong> and Azure <strong>Function Apps</strong> for governance and user lifecycle automation.</li>
                                <li><strong>ADF ELT</strong> pipelines into Azure SQL and <strong>Synapse SQL pool</strong> with dimensional models.</li>
                                <li>Enterprise <strong>Power BI RLS</strong> patterns and automated refresh/access flows.</li>
                                <li>Blazor, MVC, and React front ends aligned to data products and stakeholder workflows.</li>
                            </ul>
                        </section>
                    </main>
                </div>
            </section>
            <!-- =================== /1-PAGE SUMMARY =================== -->
            <!-- ===== TOP-OF-PAGE: Highlights -> Experience -> Education ===== -->
            <section class="mb-3" id="highlights">
                <h2 class="sect">Highlights</h2>
                <div class="exp">
                    <ul class="exp-bullets">
                        <li>Lead engineer for Treasury's shared analytics platform serving <strong>250+</strong> devs/analysts.</li>
                        <li>Migrated <strong>600+</strong> projects to Azure DevOps; standardized Repos/Boards/Wikis/Pipelines.</li>
                        <li>Admin for <strong>Power BI Service</strong> &amp; <strong>Report Server</strong> (upgrades, tuning, uptime).</li>
                        <li>Built production <strong>ADF</strong> ELT into Azure SQL and <strong>Synapse SQL pool</strong>.</li>
                        <li>Delivered <strong>.NET APIs</strong> and Azure Functions for automation and integration.</li>
                        <li>Own enterprise <strong>RLS</strong> patterns and security tables; automate refresh/access.</li>
                    </ul>
                </div>
            </section>

            <section class="mb-3" id="experience">
                <h2 class="sect">Experience</h2>

                @foreach (var e in GetExperienceAll())
                {
                    var bullets = e.BulletPoints?.OrderBy(b => b.Order).Take(MaxBullets);
                    <article class="exp">
                        <div class="exp-head">
                            <div>
                                <div class="exp-title">@e.Title</div>
                                @if (!string.IsNullOrWhiteSpace(e.Organization))
                                {
                                    <div class="exp-sub">@e.Organization</div>
                                }
                                @if (!string.IsNullOrWhiteSpace(e.Location))
                                {
                                    <div class="text-muted small">@e.Location</div>
                                }
                            </div>
                            <div class="text-nowrap">
                                <span class="badge bg-primary-subtle text-primary">
                                    @FormatDateRange(e.StartDate, e.EndDate)
                                </span>
                            </div>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(e.Description))
                        {
                            <p class="mb-2 small text-muted">@e.Description</p>
                        }

                        @if (bullets?.Any() == true)
                        {
                            <ul class="exp-bullets">
                                @foreach (var bp in bullets!)
                                {
                                    <li>@bp.Text</li>
                                }
                            </ul>
                        }
                    </article>
                }
            </section>

            <section class="mb-3" id="education">
                <h2 class="sect">Education</h2>

                @foreach (var ed in GetEducationAll())
                {
                    <article class="exp">
                        <div class="exp-head">
                            <div>
                                <div class="exp-title">@ed.Title</div>
                                @if (!string.IsNullOrWhiteSpace(ed.Organization))
                                {
                                    <div class="exp-sub">@ed.Organization</div>
                                }
                                @if (!string.IsNullOrWhiteSpace(ed.Location))
                                {
                                    <div class="text-muted small">@ed.Location</div>
                                }
                            </div>
                            <div class="text-nowrap">
                                <span class="badge bg-primary-subtle text-primary">
                                    @FormatDateRange(ed.StartDate, ed.EndDate)
                                </span>
                            </div>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(ed.Description))
                        {
                            <p class="mb-2 small text-muted">@ed.Description</p>
                        }
                    </article>
                }
            </section>

            <!-- ===== BELOW THE FOLD: Skills, Certifications, Other DB-backed sections ===== -->
            <section class="mb-3" id="skills">
                <h2 class="sect">Skills</h2>
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="tile h-100">
                            <div class="tile-title mb-1">Languages &amp; Frameworks</div>
                            <div class="chips">
                                @Chip("C# / .NET") @Chip("ASP.NET Core")
                                @Chip("Blazor") @Chip("MVC") @Chip("React")
                                @Chip("Python") @Chip("T-SQL")
                                @Chip("PowerShell")
                                @Chip("Razor") @Chip("REST APIs") @Chip("LINQ")
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="tile h-100">
                            <div class="tile-title mb-1">Data &amp; BI</div>
                            <div class="chips">
                                @Chip("Azure SQL") @Chip("Synapse SQL pool") @Chip("EF Core")
                                @Chip("Power BI (Service/RS, RLS)") @Chip("DAX") @Chip("Dimensional Modeling")
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="tile h-100">
                            <div class="tile-title mb-1">Cloud &amp; DevOps</div>
                            <div class="chips">
                                @Chip("Azure") @Chip("Azure DevOps (Repos/Boards/Wikis/Pipelines)")
                                @Chip("CI/CD") @Chip("Git") @Chip("Azure Functions") @Chip("Azure Data Factory")
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="tile h-100">
                            <div class="tile-title mb-1">Security &amp; Delivery</div>
                            <div class="chips">
                                @Chip("CSP / Headers / Validation") @Chip("Antiforgery") @Chip("Rate Limiting")
                                @Chip("Agile / Scrum") @Chip("Mentoring & Reviews")
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="mb-3" id="certs">
                <h2 class="sect">Certifications</h2>
                <div class="exp">
                    <div class="d-flex flex-wrap gap-2 mb-1">
                        <a class="chip" href="https://www.credly.com/badges/15b0a37b-949e-4524-8712-8c69ab4030d8/public_url" target="_blank" rel="noopener">Azure Fundamentals</a>
                        <a class="chip" href="https://www.credly.com/badges/c430137f-c648-4e46-980e-c2670fa734d6/public_url" target="_blank" rel="noopener">Azure Data Fundamentals</a>
                        <a class="chip" href="https://www.credly.com/badges/fd62d8eb-1d69-4b3b-9138-44c50c2e86ae/public_url" target="_blank" rel="noopener">Azure AI Fundamentals</a>
                    </div>
                    <div class="text-muted small">Credly profile linked.</div>
                </div>
            </section>

            @if (_sections.Count == 0)
            {
                <div class="alert alert-info">No resume data available yet.</div>
            }
            else
            {
                @foreach (var s in GetOtherSections())
                {
                    IEnumerable<ResumeEntryDto> entries = s.Entries;
                    if (s.SectionTitle?.Contains("Experience", StringComparison.OrdinalIgnoreCase) == true)
                    {
                        entries = entries
                        .OrderByDescending(e => e.EndDate ?? DateTime.MaxValue)
                        .ThenByDescending(e => e.StartDate);
                    }

                    <section class="mb-4">
                        <h3 class="h5 border-bottom pb-2">@s.SectionTitle</h3>

                        @foreach (var e in entries)
                        {
                            var bullets = e.BulletPoints?.OrderBy(b => b.Order).Take(MaxBullets);

                            <article class="exp">
                                <div class="exp-head">
                                    <div>
                                        <div class="exp-title">@e.Title</div>
                                        @if (!string.IsNullOrWhiteSpace(e.Organization))
                                        {
                                            <div class="exp-sub">@e.Organization</div>
                                        }
                                        @if (!string.IsNullOrWhiteSpace(e.Location))
                                        {
                                            <div class="text-muted small">@e.Location</div>
                                        }
                                    </div>
                                    <div class="text-nowrap">
                                        <span class="badge bg-primary-subtle text-primary">
                                            @FormatDateRange(e.StartDate, e.EndDate)
                                        </span>
                                    </div>
                                </div>

                                @if (!string.IsNullOrWhiteSpace(e.Description))
                                {
                                    <p class="mb-2 small text-muted">@Shorten(e.Description, 160)</p>
                                }

                                @if (bullets?.Any() == true)
                                {
                                    <ul class="exp-bullets">
                                        @foreach (var bp in bullets!)
                                        {
                                            <li>@bp.Text</li>
                                        }
                                    </ul>
                                }
                            </article>
                        }
                    </section>
                }
            }
        }
    </div>
</section>

@code {
    private List<ResumeSectionDto>? _sections;
    private string? _error;
    private const int MaxBullets = 4;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var http = HttpFactory.CreateClient();
            var uri = new Uri(new Uri(Nav.BaseUri), "api/resume");
            _sections = await http.GetFromJsonAsync<List<ResumeSectionDto>>(uri);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private RenderFragment Chip(string text) => __builder =>
    {
        __builder.OpenElement(0, "span");
        __builder.AddAttribute(1, "class", "chip");
        __builder.AddContent(2, text);
        __builder.CloseElement();
    };

    private static string Shorten(string text, int max)
    {
        var t = Regex.Replace(text ?? string.Empty, "\\s+", " ").Trim();
        if (t.Length <= max) return t;
        return t.Substring(0, Math.Max(0, max)).TrimEnd() + "...";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Position the export menu next to the button,
            // and wire up outside-click / Esc to close.
            await JS.InvokeVoidAsync("resume.initExportDropdowns");
        }
    }

    private static string FormatDateRange(DateTime start, DateTime? end)
    {
        var to = (end ?? DateTime.Today);
        if (to < start) to = start;

        var monthDiff = (to.Year - start.Year) * 12 + (to.Month - start.Month) - (to.Day < start.Day ? 1 : 0);
        var years = Math.Max(0, monthDiff / 12);
        var months = Math.Max(0, monthDiff % 12);

        string tenure;
        if (years == 0 && months == 0)
        {
            var days = (to - start).Days;
            tenure = $"{days} day{(days == 1 ? "" : "s")}";
        }
        else
        {
            var parts = new List<string>();
            if (years > 0) parts.Add($"{years} yr{(years > 1 ? "s" : "")}");
            if (months > 0) parts.Add($"{months} mo{(months > 1 ? "s" : "")}");
            tenure = string.Join(" ", parts);
        }

        var startStr = start.ToString("MMM yyyy");
        var endStr = end.HasValue ? end.Value.ToString("MMM yyyy") : "Present";
        return $"{startStr} - {endStr} | {tenure}";
    }

    // ===== Robust helpers for 1-pager and ordering =====
    private static readonly string[] ExpKeys = new[] { "Experience", "Employment", "Work History", "Professional Experience" };
    private static readonly string[] EduKeys = new[] { "Education", "Academic" };

    private IEnumerable<ResumeEntryDto> GetExperienceAll()
    {
        var secs = _sections?
            .Where(s => !string.IsNullOrWhiteSpace(s.SectionTitle) &&
                        ExpKeys.Any(k => s.SectionTitle!.Contains(k, StringComparison.OrdinalIgnoreCase)))
            ?? Enumerable.Empty<ResumeSectionDto>();

        return secs.SelectMany(s => s.Entries)
                   .OrderByDescending(e => e.EndDate ?? DateTime.MaxValue)
                   .ThenByDescending(e => e.StartDate);
    }


    private IEnumerable<ResumeEntryDto> GetExperience(int take = 2)
        => GetExperienceAll().Take(take);

    private IEnumerable<ResumeEntryDto> GetEducationAll()
    {
        var secs = _sections?
            .Where(s => !string.IsNullOrWhiteSpace(s.SectionTitle) &&
                        EduKeys.Any(k => s.SectionTitle!.Contains(k, StringComparison.OrdinalIgnoreCase)))
            ?? Enumerable.Empty<ResumeSectionDto>();

        return secs.SelectMany(s => s.Entries)
                   .OrderByDescending(e => e.EndDate ?? DateTime.MaxValue)
                   .ThenByDescending(e => e.StartDate);
    }

    private IEnumerable<ResumeEntryDto> GetEducation(int take = 1)
        => GetEducationAll().Take(take);

    // Sections other than Experience/Education (shown after the top blocks)
    private IEnumerable<ResumeSectionDto> GetOtherSections()
    {
        if (_sections is null) return Enumerable.Empty<ResumeSectionDto>();
        return _sections
            .Where(s =>
                !string.IsNullOrWhiteSpace(s.SectionTitle) &&
                !ExpKeys.Any(k => s.SectionTitle!.Contains(k, StringComparison.OrdinalIgnoreCase)) &&
                !EduKeys.Any(k => s.SectionTitle!.Contains(k, StringComparison.OrdinalIgnoreCase))
            );
    }

    private static IEnumerable<string> TakeBullets(ResumeEntryDto e, int count)
        => e.BulletPoints?.OrderBy(b => b.Order).Select(b => b.Text).Take(count)
           ?? Enumerable.Empty<string>();

    // === Print fallbacks (optional) ===
    private Task PrintFullAsync()
        => JS.InvokeVoidAsync("resume.printResume", ".resume-container").AsTask();

    private Task PrintShortAsync()
        => JS.InvokeVoidAsync("resume.printResume", "#resume-summary").AsTask();
}
