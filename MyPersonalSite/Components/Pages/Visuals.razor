@page "/visuals"
@rendermode InteractiveServer
@using System.Net.Http.Json
@inject IHttpClientFactory HttpFactory
@inject NavigationManager Nav
@inject IJSRuntime JS

<HeadContent>
    <!-- Keep your extras; d3Interop is loaded globally or in App.razor -->
    <script src='@Assets["js/visuals-extra.js"]' defer></script>
</HeadContent>

<h1 class="display-5 mb-3">Visuals</h1>
<p class="text-muted">Interactive charts powered by EF Core + minimal APIs + D3.</p>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger"><strong>Error:</strong> @_error</div>
}
else if (_years is null || _orgsRaw is null || _kpis is null || _velocity is null || _ado is null)
{
    <p>Loading…</p>
}
else
{
    <!-- KPI strip -->
    <div class="card shadow-sm mb-3 viz-card">
        <div class="card-body">
            <h5 class="card-title">Impact at a glance</h5>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-2 viz-kpi">
                @for (var i = 0; i < _kpis.Count; i++)
                {
                    var k = _kpis[i];
                    <div class="col">
                        <div class="tile d-flex justify-content-between align-items-center h-100">
                            <div>
                                <div class="text-muted small">@k.label</div>
                                <div id="@($"kpi-spark-{i}")" style="width:140px;height:28px"></div>
                            </div>
                            <div class="fs-4 fw-bold text-primary">@k.value</div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="row gy-4 viz-row">
        <!-- Delivery velocity -->
        <div class="col-12 col-xl-6">
            <div class="card shadow-sm viz-card h-100">
                <div class="card-body">
                    <h5 class="card-title">Delivery velocity (last 4 years)</h5>
                    <div id="velocity-chart" data-viz-type="velocity" style="width:100%; max-width:900px; min-height:240px;"></div>
                </div>
            </div>
        </div>

        <!-- ADO bullet -->
        <div class="col-12 col-xl-6">
            <div class="card shadow-sm viz-card h-100">
                <div class="card-body">
                    <h5 class="card-title">ADO migrations vs goal</h5>
                    <div id="ado-bullet" data-viz-type="ado" style="width:100%; max-width:900px; min-height:56px;"></div>
                </div>
            </div>
        </div>

        <!-- Entries per Year -->
        <div class="col-12 col-xl-6">
            <div class="card shadow-sm viz-card h-100">
                <div class="card-body">
                    <h5 class="card-title">Entries per Year</h5>
                    <small class="text-muted">Data points: @_years.Count</small>
                    <div id="entries-per-year-chart" data-viz-type="year" style="width:100%; max-width:900px; min-height:420px;"></div>
                </div>
            </div>
        </div>

        <!-- Entries by Organization -->
        <div class="col-12 col-xl-6">
            <div class="card shadow-sm viz-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="card-title mb-0">Entries by Organization</h5>
                        <div class="d-flex gap-2">
                            <select class="form-select form-select-sm" style="width:auto" @onchange="OnSortChanged">
                                <option value="countDesc" selected>Count ↓</option>
                                <option value="countAsc">Count ↑</option>
                                <option value="labelAsc">A–Z</option>
                                <option value="labelDesc">Z–A</option>
                            </select>
                            <input class="form-control form-control-sm" style="width:90px" type="number" min="3" max="25" step="1"
                                   @bind="_topN" @bind:event="oninput" />
                        </div>
                    </div>
                    <small class="text-muted">Showing @((_orgsView?.Count ?? 0)) of @((_orgsRaw?.Count ?? 0))</small>
                    <div id="entries-by-org-chart" data-viz-type="org" style="width:100%; max-width:900px; min-height:300px;"></div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // --- data for existing charts ---
    private List<YearCount>? _years;
    private List<OrgCount>? _orgsRaw;
    private List<OrgCount>? _orgsView;

    // --- new data ---
    private List<KpiItem>? _kpis;
    private List<MonthCount>? _velocity;
    private BulletModel? _ado;

    // UI state
    private string _sort = "countDesc";
    private int _topN = 10;
    private string? _error;

    // Render state
    private bool _d3Ready;
    private bool _yearDrawn, _orgDrawn, _kpiDrawn, _velDrawn, _adoDrawn;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var http = HttpFactory.CreateClient();
            var baseUri = new Uri(Nav.BaseUri);

            // existing
            _years = await http.GetFromJsonAsync<List<YearCount>>(new Uri(baseUri, "api/metrics/entries-per-year"));
            _orgsRaw = await http.GetFromJsonAsync<List<OrgCount>>(new Uri(baseUri, "api/metrics/entries-by-org"));

            // new
            _kpis = await http.GetFromJsonAsync<List<KpiItem>>(new Uri(baseUri, "api/metrics/kpis"));
            _velocity = await http.GetFromJsonAsync<List<MonthCount>>(new Uri(baseUri, "api/metrics/velocity-monthly"));
            _ado = await http.GetFromJsonAsync<BulletModel>(new Uri(baseUri, "api/metrics/ado-migrations"));

            ApplyOrgView();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Return if no data or all done
        if ((_years is null && _orgsView is null) || (_yearDrawn && _orgDrawn && _kpiDrawn && _velDrawn && _adoDrawn)) return;

        // Wait for D3 + interop
        if (!_d3Ready)
        {
            try { _d3Ready = await JS.InvokeAsync<bool>("d3Interop.waitForD3"); }
            catch { await Task.Delay(50); StateHasChanged(); return; }
            if (!_d3Ready) { await Task.Delay(50); StateHasChanged(); return; }
        }

        // KPI sparklines
        if (!_kpiDrawn && _kpis is not null)
        {
            try
            {
                for (var i = 0; i < _kpis.Count; i++)
                {
                    await JS.InvokeVoidAsync("d3Interop.renderSparkline", $"#kpi-spark-{i}", _kpis[i].spark, new { width = 140, height = 28 });
                }
                _kpiDrawn = true;
            }
            catch { await Task.Delay(50); StateHasChanged(); return; }
        }

        // Delivery velocity (sequential palette over time)
        if (!_velDrawn && _velocity is not null)
        {
            try
            {
                await JS.InvokeVoidAsync("d3Interop.renderMonthlyBars",
                    "#velocity-chart", _velocity,
                    new { height = 240, palette = "blues" } // try "magma" / "plasma" too
                );
                _velDrawn = true;
            }
            catch { await Task.Delay(50); StateHasChanged(); return; }
        }

        // ADO bullet
        if (!_adoDrawn && _ado is not null)
        {
            try
            {
                await JS.InvokeVoidAsync("d3Interop.renderBulletChart",
                    "#ado-bullet", _ado,
                    new { height = 56 }
                );
                _adoDrawn = true;
            }
            catch { await Task.Delay(50); StateHasChanged(); return; }
        }

        // Entries per Year (sequential palette, colored by year)
        if (!_yearDrawn && _years is not null)
        {
            try
            {
                await JS.InvokeVoidAsync("d3Interop.renderBarChart",
                    "#entries-per-year-chart", _years,
                    new { height = 420, palette = "purples", colorBy = "year" }
                );
                _yearDrawn = true;
            }
            catch { await Task.Delay(100); StateHasChanged(); return; }
        }

        // Entries by Org (categorical palette per org label)
        if (!_orgDrawn && _orgsView is not null)
        {
            try
            {
                await JS.InvokeVoidAsync("d3Interop.renderHorizontalBarChart",
                    "#entries-by-org-chart", _orgsView,
                    new { barHeight = 28, sort = _sort, palette = "tableau", colorBy = "org" }
                );
                _orgDrawn = true;
            }
            catch { await Task.Delay(100); StateHasChanged(); return; }
        }
    }

    private void ApplyOrgView()
    {
        if (_orgsRaw is null) return;
        IEnumerable<OrgCount> q = _orgsRaw;

        _orgsView = _sort switch
        {
            "countAsc" => q.OrderBy(x => x.count).Take(_topN).ToList(),
            "labelAsc" => q.OrderBy(x => x.org).Take(_topN).ToList(),
            "labelDesc" => q.OrderByDescending(x => x.org).Take(_topN).ToList(),
            _ => q.OrderByDescending(x => x.count).Take(_topN).ToList(),
        };
        _orgDrawn = false; // re-draw on next render
    }

    private void OnSortChanged(ChangeEventArgs e)
    {
        _sort = e.Value?.ToString() ?? "countDesc";
        ApplyOrgView();
        StateHasChanged();
    }

    // DTOs for this page
    private sealed class YearCount { public int year { get; set; } public int count { get; set; } }
    private sealed class OrgCount { public string org { get; set; } = ""; public int count { get; set; } }
    private sealed class KpiItem { public string label { get; set; } = ""; public int value { get; set; } public int[] spark { get; set; } = Array.Empty<int>(); public double? target { get; set; } }
    private sealed class MonthCount { public string month { get; set; } = ""; public int count { get; set; } }
    private sealed class BulletModel { public double value { get; set; } public double? target { get; set; } public double? max { get; set; } }
}
s