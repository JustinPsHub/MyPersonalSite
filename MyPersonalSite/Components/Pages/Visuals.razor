@page "/visuals"
@rendermode InteractiveServer
@using System.Net.Http.Json
@inject IHttpClientFactory HttpFactory
@inject NavigationManager Nav
@inject IJSRuntime JS

<PageTitle>Visuals - Delivery Metrics</PageTitle>

<HeadContent>

    <!-- Keep your extras; d3Interop is loaded globally or in App.razor -->
    <script src='@Assets["js/visuals-extra.js"]' defer></script>
</HeadContent>

<div class="container-fluid">
    <section class="viz-hero">
        <div class="card p-4">
            <span class="tag">Telemetry and delivery signals</span>
            <h1 class="display-6 mb-2">Data platform visuals</h1>
            <p class="mb-0">
                Interactive charts powered by .NET APIs and curated telemetry. These views highlight delivery
                velocity, Azure DevOps migration progress, and reliability signals for governed data platforms.
            </p>
        </div>
    </section>
</div>
@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger"><strong>Error:</strong> @_error</div>
}
else if (_years is null || _orgsRaw is null || _kpis is null || _velocity is null || _ado is null
         || _velocityMix is null || _reliability is null)
{
    <p>Loading...</p>
}

else
{
    <div class="container-fluid">
        <!-- KPI strip -->
        <div class="card shadow-sm mb-3 viz-card">
            <div class="card-body">
                <h5 class="card-title">Impact at a glance</h5>
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-2 viz-kpi">
                    @for (var i = 0; i < _kpis.Count; i++)
                    {
                        var k = _kpis[i];
                        <div class="col">
                            <div class="tile d-flex justify-content-between align-items-center h-100">
                                <div>
                                    <div class="text-muted small">@k.label</div>
                                    <div id="@($"kpi-spark-{i}")" style="width:140px;height:28px"></div>
                                </div>
                                <div class="fs-4 fw-bold text-primary">@k.value</div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="row gy-4 viz-row">
            <div class="col-12 col-xl-6">
                <div class="card shadow-sm viz-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Delivery velocity (last 4 years)</h5>
                        <div id="velocity-chart" data-viz-type="velocity" style="width:100%; min-height:240px;"></div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-xl-6">
                <div class="card shadow-sm viz-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">ADO migrations vs goal</h5>
                        <div id="ado-bullet" data-viz-type="ado" style="width:100%; min-height:56px;"></div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-xl-6">
                <div class="card shadow-sm viz-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Entries per Year</h5>
                        <small class="text-muted">Data points: @_years.Count - click a year to cross-filter</small>
                        <div id="entries-per-year-chart" data-viz-type="year" style="width:100%; min-height:420px;"></div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-xl-6">
                <div class="card shadow-sm viz-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Organization impact bubbles</h5>
                        <small class="text-muted">Same data as the bars - choose a bubble to cross-filter.</small>
                        <div id="org-bubbles-chart" style="width:100%; min-height:320px;"></div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-xl-6">
                <div class="card shadow-sm viz-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Momentum by year</h5>
                        <small class="text-muted">Cumulative impact - highlights when a bar is selected.</small>
                        <div id="year-trend-chart" style="width:100%; min-height:320px;"></div>
                    </div>
                </div>
            </div>

            <div class="col-12 col-xl-6">
                <div class="card shadow-sm viz-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Reliability rolling 90 days</h5>
                        <small class="text-muted">Success rate with surfaced incidents.</small>
                        <div id="reliability-chart" style="width:100%; min-height:320px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // --- data for existing charts ---
    private List<YearCount>? _years;
    private List<OrgCount>? _orgsRaw;
    private List<OrgCount>? _orgsView;

    // --- new data ---
    private List<KpiItem>? _kpis;
    private List<MonthCount>? _velocity;
    private List<VelocityQuarter>? _velocityMix;
    private List<ReliabilityPoint>? _reliability;
    private BulletModel? _ado;

    // UI state
    private string _sort = "countDesc";
    private int _topN = 10;
    private string? _error;

    // Render state
    private bool _d3Ready;
    private bool _yearDrawn, _orgDrawn, _kpiDrawn, _velDrawn, _adoDrawn;
    private bool _yearTrendDrawn, _orgBubbleDrawn, _velocityStackDrawn, _reliabilityDrawn;

    private int TopN
    {
        get => _topN;
        set
        {
            _topN = value;
            ApplyFilters(); // Call your filter logic here!
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var http = HttpFactory.CreateClient();
            var baseUri = new Uri(Nav.BaseUri);

            // existing
            _years = await http.GetFromJsonAsync<List<YearCount>>(new Uri(baseUri, "api/metrics/entries-per-year"));
            _orgsRaw = await http.GetFromJsonAsync<List<OrgCount>>(new Uri(baseUri, "api/metrics/entries-by-org"));

            // new
            _kpis = await http.GetFromJsonAsync<List<KpiItem>>(new Uri(baseUri, "api/metrics/kpis"));
            _velocity = await http.GetFromJsonAsync<List<MonthCount>>(new Uri(baseUri, "api/metrics/velocity-monthly"));
            _velocityMix = await http.GetFromJsonAsync<List<VelocityQuarter>>(new Uri(baseUri, "api/metrics/velocity"));
            _reliability = await http.GetFromJsonAsync<List<ReliabilityPoint>>(new Uri(baseUri, "api/metrics/reliability-90d"));
            _ado = await http.GetFromJsonAsync<BulletModel>(new Uri(baseUri, "api/metrics/ado-migrations"));

            ApplyOrgView();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Return if no data or all done
        if ((_years is null || _orgsView is null || _velocity is null || _kpis is null || _ado is null || _velocityMix is null || _reliability is null)
            || (_yearDrawn && _orgDrawn && _kpiDrawn && _velDrawn && _adoDrawn && _yearTrendDrawn && _orgBubbleDrawn && _velocityStackDrawn && _reliabilityDrawn))
        {
            return;
        }

        // Wait for D3 + interop
        if (!_d3Ready)
        {
            try { _d3Ready = await JS.InvokeAsync<bool>("d3Interop.waitForD3"); }
            catch { await Task.Delay(50); StateHasChanged(); return; }
            if (!_d3Ready) { await Task.Delay(50); StateHasChanged(); return; }
        }

        // KPI sparklines
        if (!_kpiDrawn && _kpis is not null)
        {
            try
            {
                for (var i = 0; i < _kpis.Count; i++)
                {
                    await JS.InvokeVoidAsync("d3Interop.renderSparkline", $"#kpi-spark-{i}", _kpis[i].spark,
              new { width = 140, height = 28, palette = "blues" });

                }
                _kpiDrawn = true;
            }
            catch { await Task.Delay(50); StateHasChanged(); return; }
        }

        // Delivery velocity (sequential palette over time)
        if (!_velDrawn && _velocity is not null)
        {
            try
            {
                await JS.InvokeVoidAsync("d3Interop.renderMonthlyBars",
                    "#velocity-chart", _velocity,
                    new { height = 240, palette = "blues" } // try "magma" / "plasma" too
                );
                _velDrawn = true;
            }
            catch { await Task.Delay(50); StateHasChanged(); return; }
        }

        // ADO bullet
        if (!_adoDrawn && _ado is not null)
        {
            try
            {
                await JS.InvokeVoidAsync("d3Interop.renderBulletChart",
     "#ado-bullet", _ado,
     new { height = 56, palette = "blues" });

                _adoDrawn = true;
            }
            catch { await Task.Delay(50); StateHasChanged(); return; }
        }

        // Entries per Year (sequential palette, colored by year)
        if (!_yearDrawn && _years is not null)
        {
            try
            {
                await JS.InvokeVoidAsync("d3Interop.renderBarChart",
                    "#entries-per-year-chart", _years,
                    new { height = 420, palette = "purples", colorBy = "year" }
                );
                _yearDrawn = true;
            }
            catch { await Task.Delay(100); StateHasChanged(); return; }
        }

//         // Entries by Org (categorical palette per org label)
//         if (!_orgDrawn && _orgsView is not null)
//         {
//             try
//             {
//                 await JS.InvokeVoidAsync("d3Interop.renderHorizontalBarChart",
//     "#entries-by-org-chart", _orgsView,
//     new { barHeight = 48, sort = _sort, palette = "tableau", colorBy = "org", yLabelMode = "wrap", yLabelWidth = 240 }
// );

//                 _orgDrawn = true;
//             }
//             catch { await Task.Delay(100); StateHasChanged(); return; }
//         }

        // Year momentum line (shares year filter)
        if (!_yearTrendDrawn && _years is not null)
        {
            try
            {
                await JS.InvokeVoidAsync("d3Interop.renderYearTrend", "#year-trend-chart", _years, new { height = 320 });
                _yearTrendDrawn = true;
            }
            catch { await Task.Delay(80); StateHasChanged(); return; }
        }

        // Org bubbles (shares org filter)
        if (!_orgBubbleDrawn && _orgsView is not null)
        {
            try
            {
                await JS.InvokeVoidAsync("d3Interop.renderOrgBubbles", "#org-bubbles-chart", _orgsView, new { height = 320 });
                _orgBubbleDrawn = true;
            }
            catch { await Task.Delay(80); StateHasChanged(); return; }
        }

        // Capability mix stacked columns
        if (!_velocityStackDrawn && _velocityMix is not null)
        {
            try
            {
                await JS.InvokeVoidAsync("d3Interop.renderVelocityStacked", "#velocity-stack-chart", _velocityMix, new { legend = "#velocity-stack-legend", height = 360 });
                _velocityStackDrawn = true;
            }
            catch { await Task.Delay(100); StateHasChanged(); return; }
        }

        // Reliability success rate
        if (!_reliabilityDrawn && _reliability is not null)
        {
            try
            {
                await JS.InvokeVoidAsync("d3Interop.renderReliabilityArea", "#reliability-chart", _reliability, new { height = 320 });
                _reliabilityDrawn = true;
            }
            catch { await Task.Delay(100); StateHasChanged(); return; }
        }
    }

    private void ApplyFilters()
    {
        ApplyOrgView();
        // No need for StateHasChanged() here, as the framework handles it
        // when an event handler is invoked.
    }

    private void ApplyOrgView()
    {
        if (_orgsRaw is null) return;
        IEnumerable<OrgCount> q = _orgsRaw;

        _orgsView = _sort switch
        {
            "countAsc" => q.OrderBy(x => x.count).Take(_topN).ToList(),
            "labelAsc" => q.OrderBy(x => x.org).Take(_topN).ToList(),
            "labelDesc" => q.OrderByDescending(x => x.org).Take(_topN).ToList(),
            _ => q.OrderByDescending(x => x.count).Take(_topN).ToList(),
        };
        _orgDrawn = false; // re-draw on next render
        _orgBubbleDrawn = false;
    }

    private void OnSortChanged(ChangeEventArgs e)
    {
        _sort = e.Value?.ToString() ?? "countDesc";
        ApplyFilters();
    }

    // DTOs for this page
    private sealed class YearCount { public int year { get; set; } public int count { get; set; } }
    private sealed class OrgCount { public string org { get; set; } = ""; public int count { get; set; } }
    private sealed class KpiItem { public string label { get; set; } = ""; public int value { get; set; } public int[] spark { get; set; } = Array.Empty<int>(); public double? target { get; set; } }
    private sealed class MonthCount { public string month { get; set; } = ""; public int count { get; set; } }
    private sealed class VelocityQuarter
    {
        public string period { get; set; } = "";
        public int apps { get; set; }
        public int funcs { get; set; }
        public int adf { get; set; }
        public int pbi { get; set; }
    }
    private sealed class ReliabilityPoint
    {
        public DateTime date { get; set; }
        public int ok { get; set; }
        public int fail { get; set; }
    }
    private sealed class BulletModel { public double value { get; set; } public double? target { get; set; } public double? max { get; set; } }
}


